# Gitlab component for triggering and delegating to a child pipeline
spec:
  inputs:
    service_name:
    service_root:
    version_pattern:
      default: "v(\\d+.){1,2}\\d+"
---
"trigger-$[[ inputs.service_name ]]":
  stage: trigger
  # redeclare such that childs have access
  variables:
    SERVICE_NAME: "$[[ inputs.service_name ]]"
    SERVICE_ROOT: "$[[ inputs.service_root ]]"
    RELEASE_TAG_PATTERN: "/^$[[ inputs.service_name ]]-$[[ inputs.version_pattern ]]$$/"
  rules:
    # trigger if tag matches release pattern or on service changes
    - if: $CI_COMMIT_TAG =~ $RELEASE_TAG_PATTERN
    - changes:
        - "$[[ inputs.service_root ]]/**"

  trigger:
    include: "$[[ inputs.service_root ]]/.*-ci.yml"
    strategy: depend
