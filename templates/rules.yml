# Gitlab component for triggering and delegating to a child pipeline
spec:
  inputs:
    service:
---
".$[[ inputs.service ]]_base":
  variables:
    RELEASE_PATTERN: "/$[[ inputs.service ]]*/i"
  rules:
    - if: '($CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_TAG == null)'
      changes:
        paths:
          - "$[[ inputs.service ]]/**"
    - if: '($CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG == null)'
      changes:
        paths:
          - "$[[ inputs.service ]]/**"
    - if: $CI_COMMIT_TAG =~ $RELEASE_PATTERN
    - if: $CI_COMMIT_REF_SLUG =~ $RELEASE_PATTERN
    - if: $DOCKER_ENV_CI_COMMIT_TAG =~ $RELEASE_PATTERN
    - if: $DOCKER_ENV_CI_COMMIT_REF_SLUG =~ $RELEASE_PATTERN

"define-$[[ inputs.service ]]-rules":
  extends: ".$[[ inputs.service ]]_base":
  script:
    - |
      echo "trigger defined for $[[ inputs.service ]]:"
      echo "------------------------------------------------"
      echo 'on_merge_request for changes to "$[[ inputs.service ]]/**"    : yes'
      echo 'on_tagless_commit for changes to "$[[ inputs.service ]]/**"   : yes'
      echo 'on_pushed_tagged_commit                                       : yes'

